<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rage TV</title>
<style>
body { margin:0; font-family: Arial,sans-serif; background:#111; color:#fff; transition:0.3s; }
body.light { background:#f5f5f5; color:#111; }
header { display:flex; justify-content:space-between; align-items:center; padding:10px; background:#222; font-size:24px; }
body.light header { background:#ddd; color:#111; }

#playerContainer { width:80%; max-width:900px; margin:10px auto; border:2px solid #fff; border-radius:10px; background:black; height:360px; }
video#liveTV { width:100%; height:100%; border-radius:10px; background:black; cursor:pointer; }

#categoryTabs { display:flex; justify-content:center; margin:10px 0; gap:10px; flex-wrap:wrap; align-items:center; }
.categoryTab { padding:5px 10px; cursor:pointer; border-radius:5px; border:1px solid #444; }
.categoryTab.active { background:#fff; color:#111; }
body.light .categoryTab.active { background:#222; color:#fff; }

#channelSearch { padding:5px 10px; width:200px; border-radius:5px; border:1px solid #444; text-align:center; }

.categorySection { border:1px solid #444; margin:5px 0; border-radius:5px; }
.categoryHeader { padding:5px 10px; font-weight:bold; background:#333; cursor:pointer; user-select:none; display:flex; justify-content:space-between; align-items:center; }
.categoryChannels { display:none; flex-direction:column; }

.channelRow { display:grid; grid-auto-columns:minmax(150px,1fr); grid-auto-flow:column; margin:2px 0; }
.channelHeader { background:#444; font-weight:bold; padding:5px; cursor:pointer; position:sticky; left:0; z-index:2; }
.channelHeader:hover { background-color:#555; }
.channelCell { border-bottom:1px solid #555; border-right:1px solid #555; padding:5px; min-height:40px; display:flex; align-items:center; justify-content:flex-start; font-size:12px; position:relative; gap:5px; }
.programBlock { position:absolute; top:0; bottom:0; background:#0a74da; opacity:0.8; color:#fff; text-align:center; font-size:12px; padding:2px; border-radius:3px; cursor:pointer; overflow:hidden; display:flex; flex-direction:column; justify-content:center; align-items:center; transition: all 0.5s ease; }
.programBlock.current { border:2px solid #ff0; background-color:#ffaa00; font-weight:bold; }

</style>
</head>
<body>

<header>
  Rage TV
  <button id="themeToggle">ðŸŒ™</button>
</header>

<div id="categoryTabs">
  <input type="text" id="channelSearch" placeholder="Search channels...">
</div>

<div id="playerContainer">
  <video id="liveTV" autoplay></video>
</div>

<div id="epgGrid"></div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/dashjs/dist/dash.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flv.js/dist/flv.min.js"></script>
<script>
const video = document.getElementById('liveTV');
const themeToggle = document.getElementById('themeToggle');
const categoryTabs = document.getElementById('categoryTabs');
const channelSearch = document.getElementById('channelSearch');
const epgGrid = document.getElementById('epgGrid');

let hls,dashPlayer,flvPlayer,currentChannel=null,currentUrl="",epgData={},channels=[],activeCategory="";
let favoriteIds=JSON.parse(localStorage.getItem('rageTVFavorites')||'[]');

// --- Load M3U / EPG ---
fetch('RageTV.m3u').then(r=>r.text()).then(data=>{ channels=parseM3U(data); buildCategoryTabs(); }).catch(console.error);
fetch('epg.xml').then(r=>r.text()).then(xmlText=>{
  const parser=new DOMParser(); const xml=parser.parseFromString(xmlText,"text/xml");
  xml.querySelectorAll('programme').forEach(prog=>{
    const chId=prog.getAttribute('channel');
    if(!epgData[chId]) epgData[chId]=[];
    epgData[chId].push({ start:prog.getAttribute('start'), title:prog.querySelector('title')?.textContent||'' });
  });
});

// --- Parse M3U ---
function parseM3U(data){
  const lines=data.split('\n'); let ch=[],current=null;
  lines.forEach(line=>{
    line=line.trim();
    if(line.startsWith('#EXTINF:')){
      const nameMatch=line.match(/,(.*)$/);
      const groupMatch=line.match(/group-title="(.*?)"/i);
      const tvgIdMatch=line.match(/tvg-id="(.*?)"/i);
      const name=nameMatch?nameMatch[1].trim():'Unknown';
      const category=groupMatch?groupMatch[1].trim():'Uncategorized';
      const tvgId=tvgIdMatch?tvgIdMatch[1].trim():name;
      current={name,category,tvgId,streams:{},epg:[]};
    } else if(line && !line.startsWith('#')){
      if(current){ current.streams['HD']=line; ch.push(current); current=null; }
    }
  });
  return ch;
}

// --- Build categories ---
function buildCategoryTabs(){
  const cats=[...new Set(channels.map(c=>c.category))];
  activeCategory=cats[0];
  epgGrid.innerHTML='';

  cats.forEach(cat=>{
    const section = document.createElement('div'); section.className='categorySection';
    const header = document.createElement('div'); header.className='categoryHeader'; header.textContent=cat+' â–¾';
    const channelsDiv = document.createElement('div'); channelsDiv.className='categoryChannels';

    header.addEventListener('click',()=>{ 
      channelsDiv.style.display = channelsDiv.style.display==='flex' ? 'none':'flex';
    });

    channels.filter(c=>c.category===cat).forEach(ch=>{
      const rowWrapper = document.createElement('div'); rowWrapper.className='channelRow';
      const headerCell = document.createElement('div'); headerCell.className='channelHeader'; headerCell.textContent=ch.name;
      headerCell.addEventListener('click',()=>{ loadChannel(ch); });

      rowWrapper.appendChild(headerCell);

      const programs = epgData[ch.tvgId] || [];
      const now = new Date();
      let futurePrograms = programs.filter(p=>{
        const hr = parseInt(p.start.slice(8,10));
        const min = parseInt(p.start.slice(10,12));
        return hr>now.getHours() || (hr===now.getHours() && min>=now.getMinutes());
      });
      if(futurePrograms.length===0 && programs.length>0) futurePrograms=[programs[0]];

      futurePrograms.forEach(prog=>{
        const cell = document.createElement('div'); cell.className='channelCell';
        const block = document.createElement('div'); block.className='programBlock';
        block.innerHTML=`<div style="font-size:10px;">${prog.start.slice(8,10)}:${prog.start.slice(10,12)}</div><div>${prog.title}</div>`;
        if(prog.start.slice(8,10)==now.getHours() && prog.start.slice(10,12)<=now.getMinutes()) block.classList.add('current');
        cell.appendChild(block); rowWrapper.appendChild(cell);
      });

      channelsDiv.appendChild(rowWrapper);
    });

    section.appendChild(header);
    section.appendChild(channelsDiv);
    epgGrid.appendChild(section);
  });
}

// --- Load channel ---
function loadChannel(channel){ 
  currentChannel = channel; 
  const url = Object.values(channel.streams)[0]; 
  if(!url) return alert('No stream available');
  loadStream(url);
}

// --- Load stream ---
function loadStream(url){ 
  console.log('Loading stream:', url);
  currentUrl = url; 
  if(hls){ hls.destroy(); hls=null; } 
  if(dashPlayer){ dashPlayer.reset(); dashPlayer=null; } 
  if(flvPlayer){ flvPlayer.destroy(); flvPlayer=null; } 
  video.pause(); video.src=''; 

  if(url.endsWith('.m3u8')){ 
    if(Hls.isSupported()){ 
      hls=new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED,()=>video.play());
      hls.on(Hls.Events.ERROR,(e,d)=>console.error('HLS error',d));
    } else if(video.canPlayType('application/vnd.apple.mpegurl')){ video.src=url; video.play(); }
  } else if(url.endsWith('.mpd')){ dashPlayer=dashjs.MediaPlayer().create(); dashPlayer.initialize(video,url,true); }
  else if(url.startsWith('rtmp://')){ 
    if(flvjs.isSupported()){ flvPlayer=flvjs.createPlayer({type:'flv',url}); flvPlayer.attachMediaElement(video); flvPlayer.load(); flvPlayer.play(); } 
    else alert('RTMP not supported'); 
  } else { video.src=url; video.play().catch(e=>console.error(e)); }
}

// --- Theme toggle ---
themeToggle.addEventListener('click',()=>{ document.body.classList.toggle('light'); themeToggle.textContent=document.body.classList.contains('light')?'ðŸŒž':'ðŸŒ™'; });

// --- Double click fullscreen ---
video.addEventListener('dblclick',()=>{ !document.fullscreenElement ? video.requestFullscreen() : document.exitFullscreen(); });

// --- Volume control ---
video.addEventListener('wheel',e=>{ e.preventDefault(); let vol=video.volume-e.deltaY*0.002; vol=Math.max(0,Math.min(1,vol)); video.volume=vol; });
</script>
</body>
</html>
